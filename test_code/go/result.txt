=== BigQuery Service Account Impersonation Example Test ===

Loading environment variables from .env file...
Environment variables:
  GOOGLE_CLOUD_PROJECT: ***-***-sandbox
  ADBC_BIGQUERY_DATASET_ID: test_in_***
  ADBC_BIGQUERY_IMPERSONATE_TARGET: test-***@***.com

Building the example...
Running the example...
Note: This will fail if the service account impersonation is not properly configured.
Make sure the base service account has the 'Service Account Token Creator' role on the target service account.

Running service account impersonation examples...
Project ID: ***-***-sandbox
Dataset ID: test_in_***
Target Principal: test-***@***.com

=== Example 1: Basic Query ===
Query executed successfully with impersonated credentials!
Results:
Schema: schema:
  fields: 1
    - test_column: type=int64, nullable
Num rows: 1
Row 0: 1

=== Example 2: Bulk Insert ===
Test table created successfully!
Successfully inserted 0 rows using impersonated credentials

Querying inserted data:

=== Example 3: Metadata Queries ===
Getting table schema and metadata...
Table Schema: schema:
  fields: 3
    - name: type=utf8, nullable
      metadata: ["Collation": "", "DefaultValueExpression": "", "Description": "", "MaxLength": "0", "Repeated": "false", "Required": "false", "Type": "STRING"]
    - age: type=int64, nullable
     metadata: ["DefaultValueExpression": "", "Description": "", "Repeated": "false", "Required": "false", "Type": "INTEGER"]
    - city: type=utf8, nullable
      metadata: ["Collation": "", "DefaultValueExpression": "", "Description": "", "MaxLength": "0", "Repeated": "false", "Required": "false", "Type": "STRING"]
  metadata: ["CreationTime": "2025-07-25T16:23:05.656+09:00", "DefaultCollation": "", "Description": "", "ETag": "sFOK1xK/xssmYDJ3wUX3BQ==", "FullID": "***-***-sandbox:test_in_***.test_users", "Labels": "", "LastModifiedTime": "2025-07-25T16:23:07.805+09:00", "Location": "asia-northeast1", "Name": "", "NumBytes": "102", "NumLongTermBytes": "0", "NumRows": "4", "Type": "TABLE"]

Table Metadata:
  CreationTime: 2025-07-25T16:23:05.656+09:00
  DefaultCollation:
  Description:
  ETag: sFOK1xK/xssmYDJ3wUX3BQ==
  FullID: ***-***-sandbox:test_in_***.test_users
  Labels:
  LastModifiedTime: 2025-07-25T16:23:07.805+09:00
  Location: asia-northeast1
  Name:
  NumBytes: 102
  NumLongTermBytes: 0
  NumRows: 4
  Type: TABLE

Getting table types...
Available table types:
  - TABLE
  - VIEW
  - EXTERNAL
  - MATERIALIZED_VIEW
  - SNAPSHOT

Getting objects (tables) in the dataset...
⚠️  Warning: GetObjects failed: Invalid Argument: Cannot create array schema for filed `predicted_info_types`: len(schema.Schema) != 1
   Continuing with other metadata queries...

Getting table metadata via SQL query...
Table metadata from SQL query:
  Table ID: test_users
  Creation Time: 1753428185656 (Unix timestamp)
  Last Modified Time: 1753428187805 (Unix timestamp)
  Row Count: 4
  Size Bytes: 102
  Table Type: 1

Verifying service account impersonation...
Current user (should be the impersonated service account):
  Current User: test-bigquery-impersonation@***-***-sandbox.iam.gserviceaccount.com
  ✅ SUCCESS: Service account impersonation is working correctly!
  ✅ The table was created by the impersonated service account: test-bigquery-impersonation@***-***-sandbox.iam.gserviceaccount.com

=== Example 4: User Auth + Impersonation ===
Query executed successfully with user auth + impersonation!

=== Example 5: Error Handling ===
Connection established successfully!
Unexpected error: googleapi: Error 404: Not found: Table ***-***-sandbox:test_in_***.non_existent_table was not found in location asia-northeast1, notFound

=== Test completed ===
